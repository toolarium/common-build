#!/bin/bash

#########################################################################
#
# cb-install
#
# Copyright by toolarium, all rights reserved.
# MIT License: https://mit-license.org
#
#########################################################################


# define defaults
[ -z "$CB_DEVTOOLS_NAME" ] && CB_DEVTOOLS_NAME=devtools
[ -z "$CB_DEVTOOLS" ] && CB_DEVTOOLS="$HOME/$CB_DEVTOOLS_NAME"
#[ -z "`echo $OSTYPE | sed 's/cygwin.*//'`" ] && CLASSSEP=";" || CLASSSEP=":"

# define parameters
CB_LINE="----------------------------------------------------------------------------------------"
CB_LINEHEADER=".: "
PN=$(basename "$0")
#REL_PROG_PATH="${0%/*}"
#ABS_PROG_PATH=$(cd -- "`dirname $0`" && pwd)
#PN_BASE="${PN%*.sh}"

CB_FORCE_INSALL=false
CB_INSTALL_ONLY_STABLE=true
CB_INSTALLER_SILENT=false
CB_INSTALLER_VERSION="0.7.7"
CB_JSON="$CB_HOME/bin/cb-json"
CB_RELEASE_URL="https://api.github.com/repos/toolarium/common-build/releases"
CB_JSON_SCRIPT_URL="https://raw.githubusercontent.com/toolarium/common-build/master/bin/cb-json"
FULLTIMESTAMP="date '+%Y%d%m%H%M%S'"
USER_FRIENDLY_FULLTIMESTAMP="date '+%d.%m.%Y %H:%M:%S'"
cbErrorTemp=$(mktemp /tmp/toolarium-common-build_error.XXXXXXXXX)

CB_OS="$(uname | tr '[:upper:]' '[:lower:]')"
CB_OS=$(echo "$CB_OS" | awk '{print substr($0, 0, 7)}')
case $CB_OS in
	'linux') CB_OS="linux";;
	'freebsd') CB_OS="freebsd";;
	'windows') CB_OS="windows";;
	'mac') CB_OS="mac";;
	'darwin') CB_OS="mac";;
	'sunos') CB_OS="solaris";;
	'cygwin') CB_OS="cygwin";;
	'cygwin_') CB_OS="cygwin";;
	'aix') CB_OS="aix";;
	*) ;;
esac


#########################################################################
# Check if the binary exists
#########################################################################
existBinary() {
	if [ "$CB_OS" = "linux" ]; then
		eval "whereis -b $1 2>/dev/null | awk '{print $2}'"
	elif [ "$CB_OS" = "cygwin" ]; then
		eval "whereis -b $1 2>/dev/null | awk '{print $2}'"
	elif [ "$CB_OS" = "mac" ]; then
		eval "whereis -b $1 2>/dev/null | awk '{print $1}'"
	fi
}


#########################################################################
# Get the file size (gnu linux: stat -c %s, max: stat -f %z)
#########################################################################
getFileSize() {
	set -- $(\ls -dn "$1") && echo $5;
}


#########################################################################
# Get the current shell
#########################################################################
getCurrentShell() {
    if [ "$HTTP_REQUEST_CLI" = "curl" ]; then
		CMD="curl -fsSL http://www.in-ulm.de/~mascheck/various/whatshell/whatshell.sh | sh"
    else
		CMD="wget -q -O - /dev/null http://www.in-ulm.de/~mascheck/various/whatshell/whatshell.sh | sh"
    fi

	currentShell=$(eval $CMD | awk '{print $1}')
	if [ -z $currentShell ]; then
		[ "$(echo ${SHELL##*/})" = "zsh" ] && currentShell=".zshrc"
		[ "$(echo ${SHELL##*/})" = "ash" ] && currentShell=".ashrc"
		[ "$(echo ${SHELL##*/})" = "bash" ] && currentShell=".bashrc"
	fi

	echo $currentShell
}


#########################################################################
# Usage
#########################################################################
Usage() {
	echo "$PN - toolarium common build installer v$CB_INSTALLER_VERSION"
	echo "usage: $PN [OPTION]"
	echo ""
	echo "Overview of the available OPTIONs:"
	echo " -h, --help           Show this help message."
	echo " -v, --version        Print the version information."
	echo " --silent             Suppress the console output."
	echo " --force              Force to reinstall the common-build."
	echo " --draft              Also considers draft / pre-release versions."
	echo ""
}


#########################################################################
# Version
#########################################################################
Version() {
	echo "$CB_LINE"
	echo "toolarium common build installer $CB_INSTALLER_VERSION"
	echo "$CB_LINE"
	echo ""
}


#########################################################################
# installationSuccess
#########################################################################
installationSuccess() {
	msgInfo="or type in . ~/.bashrc"
	[ "$(echo ${SHELL##*/})" = "zsh" ] && msgInfo="or type in . ~/.zshrc"
	[ "$(echo ${SHELL##*/})" = "ash" ] && msgInfo="or type in . ~/.ashrc"
	[ "$(echo ${SHELL##*/})" = "bash" ] && msgInfo="or type in . ~/.bashrc"
	
	if [ "$CB_INSTALLER_SILENT" = "false" ]; then
		echo "${CB_LINEHEADER}Successfully installed toolarium-common-build v$releaseVersion."
		echo "${CB_LINEHEADER}The \$PATH is extended and you can start working with the command cb."
		echo ""
		read -p "Press any key to continue..." input
		echo ""
		eval $CB_HOME/bin/include/how-to.sh 2>/dev/null | more
		echo "${CB_LINEHEADER}Please re-login $msgInfo, before you start."
		[ -z "$(existBinary unzip)" ] && echo "${CB_LINEHEADER}Missing package unzip, please install it before you continue!"
		echo ""
	fi
}


#########################################################################
# installationFailed
#########################################################################
installationFailed() {
	echo ""
	echo "$CB_LINE"
	echo "Failed installation: $1"
 	[ -r "$cbErrorTemp" ] && echo "" && cat $cbErrorTemp 2>/dev/null
	echo "$CB_LINE"
}


#########################################################################
# checkInternetConnection
#########################################################################
checkInternetConnection() {
	[ -z "$(existBinary ping)" ] && return

	[ -z "$CB_ONLINE_ADDRESS" ] && CB_ONLINE_ADDRESS="8.8.8.8"
	if [ "$CB_OS" = "linux" ]; then
		CMD="ping $CB_ONLINE_ADDRESS -c 1 -w 1"
	elif [ "$CB_OS" = "cygwin" ]; then
		CMD="ping $CB_ONLINE_ADDRESS 1 1"
	elif [ "$CB_OS" = "windows" ]; then
		CMD="ping $CB_ONLINE_ADDRESS -n 1 -w 1000"
	#elif [ "$CB_OS" = "mac" ]; then
	#	CMD="ping $CB_ONLINE_ADDRESS -c 1 -w 1"
	fi

	if [ -n "$CMD" ]; then
		if ! eval "$CMD" >/dev/null 2>&1; then
			installationFailed "No internet connection detected."
			exit 1
		fi
	fi
}


#########################################################################
# checkHttpRequestCLI
#########################################################################
checkHttpRequestCLI() {
	[ -n "$(existBinary curl)" ] && echo "curl" && return
	[ -n "$(existBinary wget)" ] && echo "wget" && return
	echo ""
}


#########################################################################
# get newest cb json support
#########################################################################
getCBJson() {
	if ! [ -x "$CB_JSON" ]; then
		CB_JSON="/tmp/cb-json"
		export CB_JSON

		CMD="curl -# -sSL"
		[ "$HTTP_REQUEST_CLI" = "wget" ] && CMD="wget -q -O - /dev/null"
		CMD="$CMD $CB_JSON_SCRIPT_URL 2>$cbErrorTemp > $CB_JSON"
		echo "${CB_LINEHEADER}Get json support..."
		eval $CMD && chmod 755 $CB_JSON
	fi
}


#########################################################################
# getLatestRelease
#########################################################################
getLatestRelease() {
	CMD="curl -# -fsSL"
	[ "$HTTP_REQUEST_CLI" = "wget" ] && CMD="wget -q --header=\"Accept: application/json\" -O -"
	CMD="$CMD $CB_RELEASE_URL 2>$cbErrorTemp | $CB_JSON"
	[ "$1" = "true" ] && CMD="$CMD --filter \"prerelease=false\""
	CMD="$CMD --value --name name"

	version=$(eval "$CMD")
	[ $? -eq 0 ] && echo "$version" || echo ""
}


#########################################################################
# getRelease
#########################################################################
getRelease() {
	CMD="curl -# -fsSL"
	[ "$HTTP_REQUEST_CLI" = "wget" ] && CMD="wget -q --header=\"Accept: application/json\" -O -"
	CMD="$CMD $CB_RELEASE_URL 2>$cbErrorTemp | $CB_JSON --filter \"name=(v)?$1\\\"\" --value --name name"

 	version=$(eval "$CMD" 2>>$cbErrorTemp)
	[ $? -eq 0 ] && echo "$version" || echo ""
}


#########################################################################
# getReleaseDownloadUrl
#########################################################################
getReleaseDownloadUrl() {
	CMD="curl -# -fsSL"
	[ "$HTTP_REQUEST_CLI" = "wget" ] && CMD="wget -q --header=\"Accept: application/json\" -O -"
	CMD="$CMD $CB_RELEASE_URL 2>$cbErrorTemp | $CB_JSON"
	[ "$1" = "true" ] && CMD="$CMD --filter \"prerelease=false\""
	CMD="$CMD --filter \"name=(v)?$1\\\"\" --value --name tarball_url"
	
	downloadUrl=$(eval "$CMD" 2>>$cbErrorTemp)
	[ $? -eq 0 ] && echo "$downloadUrl" || echo ""
}


#########################################################################
# downloadRelease
#########################################################################
downloadRelease() {
	CMD="curl -# -SsL \"$1\" -o \"$2\""
	[ "$HTTP_REQUEST_CLI" = "wget" ] && CMD="wget -q -O \"$2\" \"$1\""

	eval "$CMD" 2>$cbErrorTemp
}


#########################################################################
# error handler
#########################################################################
errorhandler() {
    [ -n "$DEBUG" ] && echo "${CB_LINEHEADER}ERROR on line #$LINENO, last command: $BASH_COMMAND"
    exithandler
}


#########################################################################
# exit handler
#########################################################################
exithandler() {
	rm /tmp/cb-json >/dev/null 2>&1
	rm -f "$cbErrorTemp" >/dev/null 2>&1
}


#########################################################################
# update the shell initialisation
#########################################################################
updateShellInitialisation() {
	[ -z "$1" ] && return
	shellProfile="$1"

	# in case it does not exist, just create empty file
	! [ -f "$shellProfile" ] && touch "$shellProfile" && chmod 750 "$shellProfile"

	if [ -w "$shellProfile" ]; then
		backupFileName="${shellProfile}_cb-$(eval $FULLTIMESTAMP)"
		cp "$shellProfile" "$backupFileName" >/dev/null 2>&1 && chmod +r "$backupFileName" >/dev/null 2>&1

		if [ -z "$(cat $shellProfile | grep 'toolarium-common-build support')" ]; then
			[ "$CB_INSTALLER_SILENT" = "false" ] && echo "${CB_LINEHEADER}Modify file $shellProfile"
			echo "" >> "$shellProfile"
			echo "# toolarium-common-build support" >> "$shellProfile"
			echo "$CB_SHELL_INITIALISATION_CMD" >> "$shellProfile"
		else
			newFileName="${shellProfile}_cb-new"
			rm -f "$newFileName" >/dev/null 2>&1

			#TEST: CB_HOME="$CB_HOME/aa"
			CB_HOME_ESCAPED=$(echo "$CB_HOME" | sed 's/\//\\\//g')
			[ "$CB_INSTALLER_SILENT" = "false" ] && echo "${CB_LINEHEADER}Update file $shellProfile"
			cat "$shellProfile" | sed "s/CB_HOME\=.*\&/CB_HOME\=\"$CB_HOME_ESCAPED\"\ \&\&/g" > "$newFileName"
			chmod --reference="$shellProfile $newFileName" >/dev/null 2>&1
			chmod +r+w "$newFileName" >/dev/null 2>&1
			mv -f "$newFileName" "$shellProfile" >/dev/null 2>&1
		fi
	else
		echo "${CB_LINEHEADER}Can not set CB_HOME in $shellProfile, it's write protected."
	fi
}


#########################################################################
# main
#########################################################################
trap 'exithandler $?; exit' 0
trap 'errorhandler $?; exit' 1 2 3 15

CB_INSTALL_PARAMETERS=

# check curl
while [ $# -gt 0 ]
do
    case "$1" in
	-h)	Usage; exit 0;;
	--help)	Usage; exit 0;;
	-v)	Version; exit 0;;
	--version)	Version; exit 0;;
	--silent) 	CB_INSTALLER_SILENT=true;;
	--force)	CB_FORCE_INSALL=true;;
	--draft) 	CB_INSTALL_ONLY_STABLE=false;;
	*)	CB_INSTALL_PARAMETERS="$CB_INSTALL_PARAMETERS $1";;
    esac
    shift
done

if [ "$CB_INSTALLER_SILENT" = "false" ]; then
	CB_VERSION_INFO=
	[ -n "$CB_VERSION" ] && CB_VERSION_INFO=" $CB_VERSION"
	echo "$CB_LINE"
	echo "${CB_LINEHEADER}Thank you for installing toolarium-common-build$CB_VERSION_INFO on $(hostname)"
	echo "${CB_LINEHEADER}Use $CB_DEVTOOLS path as devtools folder, $(eval "$USER_FRIENDLY_FULLTIMESTAMP")"
	echo "$CB_LINE"
	read -p " Press any key to continue..." input
	echo ""
fi

HTTP_REQUEST_CLI=$(checkHttpRequestCLI)
[ -z "$HTTP_REQUEST_CLI" ] && installationFailed "Either curl or wget is required.\nPlease install curl package (e.g. sudo apt install curl)" && exit 1
checkInternetConnection

if [ "$CB_INSTALLER_SILENT" = "false" ]; then
	[ -z "$CB_INSTALL_PARAMETERS" ] && echo "${CB_LINEHEADER}Check newest version of toolarium-common-build..."
	[ -n "$CB_INSTALL_PARAMETERS" ] && echo "${CB_LINEHEADER}Check version ${CB_INSTALL_PARAMETERS# *} of toolarium-common-build..."
fi

# check common build json support
getCBJson

CB_VERSION=
if [ -n "$CB_INSTALL_PARAMETERS" ]; then
	CB_VERSION=$CB_INSTALL_PARAMETERS	
	[ "${CB_VERSION#v*}" = "$CB_VERSION" ] || CB_VERSION="v$CB_VERSION"
	releaseVersion=$(getRelease $CB_VERSION)
else
	releaseVersion=$(getLatestRelease $CB_INSTALL_ONLY_STABLE)
fi

[ -z "$releaseVersion" ] && installationFailed "Could not get remote release information." && exit 1
[ "$CB_INSTALLER_SILENT" = "false" ] && echo "${CB_LINEHEADER}Latest version of common-build is $releaseVersion, select download link"
downloadUrl=$(getReleaseDownloadUrl $releaseVersion)

[ -z "$downloadUrl" ] && installationFailed "Could not get download url of verison $releaseVersion." && exit 1
rm -f "$cbErrorTemp" >/dev/null 2>&1
CB_VERSION_NAME="toolarium-common-build-$releaseVersion"

# create directories
! [ -d "$CB_DEVTOOLS" ] && mkdir "$CB_DEVTOOLS" >/dev/null 2>&1 && echo "${CB_LINEHEADER}Create directory $CB_DEVTOOLS"
CB_DEV_REPOSITORY="$CB_DEVTOOLS/.repository"
! [ -d "$CB_DEV_REPOSITORY" ] && mkdir "$CB_DEV_REPOSITORY" >/dev/null 2>&1

# download toolarium-common-build
[ "$CB_FORCE_INSALL" = "true" ] && rm -f "$CB_DEV_REPOSITORY/$CB_VERSION_NAME.tgz" >/dev/null 2>&1
if [ -r "$CB_DEV_REPOSITORY/$CB_VERSION_NAME.tgz" ]; then
	[ "$CB_INSTALLER_SILENT" = "false" ] && echo "${CB_LINEHEADER}Found already downloaded version, $CB_DEV_REPOSITORY/$CB_VERSION_NAME.tgz"
else
	[ "$CB_INSTALLER_SILENT" = "false" ] && echo "${CB_LINEHEADER}Install $CB_VERSION_NAME"
	downloadRelease "$downloadUrl" "$CB_DEV_REPOSITORY/$CB_VERSION_NAME.tgz"

	# in case we donwload a new version we also extract new
	! [ -r "$CB_DEV_REPOSITORY/$CB_VERSION_NAME.tgz" ] && installationFailed "Could not download version $releaseVersion." && exit 1
	[ $(getFileSize $CB_DEV_REPOSITORY/$CB_VERSION_NAME.tgz) -gt 0 ] && rm -rf "$CB_DEVTOOLS/$CB_VERSION_NAME" >/dev/null 2>&1
fi

if ! [ -r "$CB_DEVTOOLS/$CB_VERSION_NAME" ]; then
	[ "$CB_INSTALLER_SILENT" = "false" ] && echo "${CB_LINEHEADER}Extract $CB_VERSION_NAME.tgz in $CB_DEVTOOLS..."

	tar -zxf "$CB_DEV_REPOSITORY/$CB_VERSION_NAME.tgz" -C "$CB_DEV_REPOSITORY/" >/dev/null 2>&1
	tarContentName=$(find $CB_DEV_REPOSITORY/* -type d -name 'toolarium-common-build-*' -print 2>/dev/null)
	mv "$tarContentName" "$CB_DEVTOOLS/$CB_VERSION_NAME" >/dev/null 2>&1

	# remove unecessary files
	rm "$CB_DEVTOOLS/$CB_VERSION_NAME/.gitattributes" >/dev/null 2>&1
	rm "$CB_DEVTOOLS/$CB_VERSION_NAME/.gitignore" >/dev/null 2>&1
	rm "$CB_DEVTOOLS/$CB_VERSION_NAME/README.md" >/dev/null 2>&1

	# keep backward compatibility
	if [ -d "$CB_DEVTOOLS/$CB_VERSION_NAME/src" ]; then
		mkdir "$CB_DEVTOOLS/$CB_VERSION_NAME/bin"
		cp "$CB_DEVTOOLS/$CB_VERSION_NAME/src/main/cli/*" "$CB_DEVTOOLS/$CB_VERSION_NAME/bin/" >/dev/null 2>&1
		rm -rf "$CB_DEVTOOLS/$CB_VERSION_NAME/src" >/dev/null 2>&1
	fi

	chmod -R +x "$CB_DEVTOOLS/$CB_VERSION_NAME/bin" >/dev/null 2>&1
	mkdir "$CB_DEVTOOLS/$CB_VERSION_NAME/current" >/dev/null 2>&1
fi

if ! [ "$CB_HOME" = "$CB_DEVTOOLS/$CB_VERSION_NAME" ]; then
	[ "$CB_INSTALLER_SILENT" = "false" ] && echo "${CB_LINEHEADER}Set CB_HOME to $CB_DEVTOOLS/$CB_VERSION_NAME"
	export CB_HOME="$CB_DEVTOOLS/$CB_VERSION_NAME"
	export PATH="$CB_HOME/bin:$PATH"
	CB_SHELL_INITIALISATION_CMD="export CB_HOME=\"$CB_HOME\" && export PATH=\"\$CB_HOME/bin:\$PATH\""

	[ -n "$(existBinary bash)" ] && updateShellInitialisation "$HOME/.bashrc"
	[ -n "$(existBinary ash)" ] && updateShellInitialisation "$HOME/.ashrc"
	[ -n "$(existBinary zsh)" ] && updateShellInitialisation "$HOME/.zshrc"
	
	#if [ -n "$(existBinary fish)" ]; then
	#	CB_SHELL_INITIALISATION_CMD="set -x CB_HOME $CB_HOME && set -x PATH \$PATH \$CB_HOME/bin"
	#	updateShellInitialisation "$HOME/.config/fish/config.fish"
	#fi
fi

installationSuccess


#########################################################################
# EOF
#########################################################################
